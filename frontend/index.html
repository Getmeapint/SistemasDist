<!DOCTYPE html>
<html>
<head>
    <title>Trail Running Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        select {
            padding: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="raceSelect">Select Race:</label>
        <select id="raceSelect">
            <option value="runner-events">Default Race</option>
            <option value="race-trail_route_1">Trail Route 1</option>
            <option value="race-trail_route_2">Trail Route 2</option>
            <option value="race-trail_route_3">Trail Route 3</option>
            <option value="race-trail_route_4">Trail Route 4</option>
        </select>
    </div>

    <div id="map"></div>

    <script>
        // Initialize map
        const map = L.map('map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Icons
        const maleIcon = L.icon({
            iconUrl: "male.png",
            iconSize: [28, 65],
            iconAnchor: [12, 64],
            popupAnchor: [-3, -46]
        });
        const femaleIcon = L.icon({
            iconUrl: "female.png",
            iconSize: [28, 65],
            iconAnchor: [12, 64],
            popupAnchor: [-3, -46]
        });

        // Athlete state
        const athleteMarkers = {};
        const athleteData = {};  // stores last known position for leaderboard logic

        // GPX layer management
        let gpxLayer = null;
        function loadGPX(routeFile) {
            if (gpxLayer) map.removeLayer(gpxLayer);
            gpxLayer = new L.GPX(routeFile, {
                async: true,
                marker_options: {
                    startIconUrl: "start.png",
                    endIconUrl: "finish.png",
                }
            }).on('loaded', function(e) {
                map.fitBounds(e.target.getBounds());
            }).addTo(map);
        }

        // --- WebSocket Handling ---
        let socket = null;
        function connectWebSocket(raceTopic) {
            if (socket) socket.close();

            const wsUrl = `ws://localhost:8000/ws?race=${raceTopic}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => console.log(`Connected to ${raceTopic}`);
            socket.onclose = () => console.log(`Disconnected from ${raceTopic}`);
            socket.onerror = err => console.error("WebSocket error:", err);

            socket.onmessage = event => {
                const data = JSON.parse(event.data);
                const athlete = data.athlete;
                const gender = data.gender;
                const lat = data.location.latitude;
                const lon = data.location.longitude;
                const race = data.race || "runner-events";

                const icon = gender === "male" ? maleIcon : femaleIcon;

                athleteData[athlete] = { lat, lon, race };

                if (athleteMarkers[athlete]) {
                    athleteMarkers[athlete].setLatLng([lat, lon]);
                } else {
                    const marker = L.marker([lat, lon], {icon: icon})
                        .addTo(map)
                        .bindPopup(`<b>${athlete}</b><br>${race}`);
                    athleteMarkers[athlete] = marker;
                }
            };
        }

        // --- Race selection ---
        const raceSelect = document.getElementById("raceSelect");
        raceSelect.addEventListener("change", (e) => {
            const selectedRace = e.target.value;
            console.log("Switching to race:", selectedRace);
            connectWebSocket(selectedRace);

            // Attempt to load corresponding GPX
            const gpxFile = `gpx/${selectedRace.replace("race-", "")}.gpx`;
            loadGPX(gpxFile);
        });

        // Initialize first connection
        connectWebSocket(raceSelect.value);
        loadGPX('gpx/trail_route_1.gpx');
    </script>
</body>
</html>
